<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Backend providing Weather and Place Photos services.
 *@namespace NeighborhoodBackend
 */

const express = require('express');
const app = express();

const http = require('http');

const requests = require('./promises');

const config = require('./config.json');
const places = require('./places.json');

app.use((req, res, next) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET');
    next();
});

app.use('/', express.static('static/', {etag: true}));
app.use('/docs', express.static('out/', {etag: true}));

/**
 * GET /api/places&lt;br>
 * Endpoint for Places listing.&lt;br>
 *
 * @memberOf NeighborhoodBackend
 * @method getApiPlaces
 */
app.route('/api/places').get((req, res) => {
    res.status(200).json(places);
});

/**
 * GET /api/weather/:lat;long&lt;br>
 * Endpoint for weather information queries.&lt;br>
 *
 * Data provided by OpenWeatherMap.
 * @see {@link https://openweathermap.org/api|OpenWeatherMap}
 *
 * @memberOf NeighborhoodBackend
 * @method getApiWeather
 */
app.route('/api/weather/:lat;:lon').get((req, res) => {
    const key = config.api.openweather.key;
    const lat = req.params.lat;
    const lon = req.params.lon;

    http.get(`http://api.openweathermap.org/data/2.5/weather?lat=${lat}&amp;lon=${lon}&amp;units=metric&amp;appid=${key}`, (rez) => {
        const { statusCode } = rez;

        if (statusCode !== 200) {
            console.error(`Error querying OpenWeather API: ${rez.statusMessage}`);
            rez.resume();
            res.status(500);
            return;
        }

        let jsonResponse = '';
        rez.setEncoding('utf-8');

        rez.on('data', (chunk) => { jsonResponse += chunk });
        rez.on('end', () => { res.status(200).json(JSON.parse(jsonResponse)) })
            .on('error', (error) => { console.error(`Error parsing JSON: ${e.message}`); res.status(500); });

    });

});

/**
 * GET /api/place/:lat;long&lt;br>
 * Endpoint for place photos.&lt;br>
 *
 * Data provided by Foursquare.&lt;br>
 * @see {@link https://developer.foursquare.com/|Foursquare Developer Site}
 *
 * @memberOf NeighborhoodBackend
 * @method getApiPlaces
 */
app.route('/api/place/:lat;:lon').get((req, res) => {
    const lat = req.params.lat;
    const lon = req.params.lon;

    let place = {};

    requests.venueRequest(lat, lon).then((placeJson) => {
        const venue = placeJson.response.venues[1];

        place = {
            id: venue.id,
            categories: venue.categories.map((c) => c.name).reduce((i, j) => `${i}, ${j}`)
        };
        return requests.photoRequest(venue.id);
    }).then((photosJson) => {
        place.photos = photosJson.response.photos.items.map((p) => `${p.prefix}${p.width}x${p.height}${p.suffix}`);
        res.status(200).json(place);
    })
        .catch((e) => res.status(500));

});

app.listen(3000, () => {
    console.log('Online');
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="MapViewModel.html">MapViewModel</a></li><li><a href="Marker.html">Marker</a></li><li><a href="Weather.html">Weather</a></li></ul><h3>Namespaces</h3><ul><li><a href="NeighborhoodBackend.html">NeighborhoodBackend</a></li></ul><h3>Global</h3><ul><li><a href="global.html#MESSAGE">MESSAGE</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Sun Jul 16 2017 19:36:16 GMT-0300 (BRT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
